# Implementation Plan

## Overview

背景色変更機能の実装タスクリスト。パレット画面とシェード画面で任意の背景色を選択し、コントラスト値をリアルタイム再計算する機能を提供する。

## Tasks

- [ ] 1. 状態管理の拡張
- [x] 1.1 (P) 背景色状態をDemoStateに追加する
  - DemoStateにbackgroundColor（HEX形式）とbackgroundMode（light/dark）を追加
  - デフォルト値として#ffffff（白）とlightモードを設定
  - resetState()で背景色状態もリセットされるようにする
  - _Requirements: 5.1_

- [x] 1.2 背景色のlocalStorage永続化を実装する
  - 背景色とモードをJSON形式（{hex, mode}）でlocalStorageに保存
  - ページ読み込み時にlocalStorageから背景色を復元し、determineColorModeでモードを再計算
  - 無効な保存値の場合はデフォルト値（#ffffff）にフォールバック
  - localStorageキーは`leonardo-backgroundColor`を使用
  - **依存**: Task 1.1完了後に着手
  - _Requirements: 5.3, 5.4_

- [ ] 2. 色変換とモード判定
- [x] 2.1 (P) OKLCHベースのカラーモード自動判定を実装する
  - sRGB HEX入力をculori.jsでOKLCHに変換（D65白色点準拠）
  - OKLCH明度（L値）が0.5超ならlightモード、0.5以下ならdarkモードを判定
  - プリセット色はあらかじめモードを関連付けておく
  - _Requirements: 2.3, 2.4, 2.5_

- [x] 2.2 (P) 入力バリデーション関数を実装する
  - HEX形式バリデーション（正規表現 `^#[0-9A-Fa-f]{6}$`）
  - OKLCH形式バリデーション（L:0.0-1.0, C:0.0-0.4, H:0-360）
  - 範囲外・NaN入力時はエラーを返し、前値を保持
  - _Requirements: 1.4, 1.5_

- [ ] 3. コントラスト計算の拡張
- [x] 3.1 背景色を引数として受け取るコントラスト計算を実装する
  - 既存のgetContrast関数を拡張し、任意の背景色に対するWCAG 2.1コントラスト比を計算
  - WCAG比はsRGB相対輝度（標準ガンマ補正）で計算し、wcagContrastを使用
  - APCA Lc値も同時に計算して返却（表示のみ、バッジ判定には使用しない）
  - AAA/AA/L/failレベルの判定関数を実装（AAA≥7.0, AA≥4.5, L≥3.0）※WCAGのみで判定
  - 20色パレットで200ms以内のパフォーマンスを確保
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.3_

- [ ] 4. 背景色セレクターUIコンポーネント
- [x] 4.1 基本的な背景色セレクターを実装する
  - カラーピッカー（input type="color"）とHEX入力フィールドを配置
  - 現在の背景色をプレビュー表示
  - エラーメッセージ表示エリアを設ける
  - aria-labelでアクセシビリティ対応
  - _Requirements: 1.1, 1.2, 1.5, 1.6_

- [x] 4.2 プリセット背景色ボタンを実装する
  - White (#ffffff), Light Gray (#f8fafc), Dark Gray (#18181b), Black (#000000) の4プリセット
  - クリックで即座に背景色を適用
  - キーボード操作（Tab/Enter）でプリセット選択可能
  - _Requirements: 2.1, 2.2_

- [x] 4.3 詳細モード（OKLCH入力）を実装する
  - 詳細モード切替トグルを追加（初期状態OFF）
  - ONの場合、L/C/Hの個別入力フィールドを表示
  - OKLCH入力時も同様のバリデーションとエラー表示
  - _Requirements: 1.3_

- [x] 4.4 入力のデバウンス処理を実装する
  - HEX入力時は150msのデバウンスを適用
  - カラーピッカーはリアルタイムで更新
  - デバウンス中も視覚的なローディング表示なしでシームレスに動作
  - _Requirements: 4.1, 4.2, 4.4_

- [ ] 5. ビュー層の背景色対応
- [x] 5.1 パレットビューに背景色セレクターを統合する
  - palette-view上部に背景色セレクターを配置
  - 背景色変更時にパレット全体の背景を更新
  - 背景色変更時に再レンダリングで色スケールを再計算（findColorForContrastが新背景色を使用）
  - NOTE: コントラスト値のUI表示（WCAG/APCAバッジ）はTask 6.2で実装
  - _Requirements: 1.1, 5.1_

- [ ] 5.2 シェードビューに背景色を適用する
  - shades-view上部に背景色セレクターを配置
  - シェードプレビュー領域とシェードグリッドに背景色を適用
  - ホバー時のコントラスト表示にも新背景色を反映
  - _Requirements: 1.1, 3.5, 5.5, 5.6_

- [ ] 5.3 画面間での背景色同期を確認する
  - パレット画面とシェード画面で背景色が同期することを確認
  - アクセシビリティビューも含めビュー切替時に背景色を維持
  - DemoStateを単一ソースとして全ビューで参照
  - _Requirements: 5.2, 5.5_

- [ ] 6. UI適応（モード対応）
- [ ] 6.1 (P) テキスト色のモード切替を実装する
  - lightモードでは黒テキスト（#18181b）
  - darkモードでは白テキスト（#f4f4f5）
  - CSS変数（--fg-primary）を活用
  - _Requirements: 6.1_

- [ ] 6.2 (P) コントラストバッジのモード対応を実装する
  - AAA/AA/L/failバッジの背景色・テキスト色・ボーダー色をモードに応じて切替
  - design.mdのBADGE_COLORS定義に従う
  - _Requirements: 6.2_

- [ ] 6.3 スウォッチボーダーのモード対応と低コントラスト強調を実装する
  - 通常時: lightモードでzinc-200、darkモードでzinc-700のボーダー
  - 背景色との対比が1.5未満の場合、強調ボーダー（2px + シャドウ）を適用
  - シェードスウォッチにも同様のボーダー調整を適用
  - _Requirements: 6.3, 6.4_

- [ ] 7. テストとパフォーマンス検証
- [ ] 7.1 ユニットテストを作成する
  - validateBackgroundColor: HEX/OKLCH形式バリデーション
  - determineColorMode: L値境界ケース（0.49, 0.50, 0.51）
  - getContrastLevel: AAA/AA/L/fail判定境界
  - calculateContrastResult: 既知の色ペアでの検証
  - persistBackgroundColor/loadBackgroundColor: localStorage操作
  - _Requirements: 1.4, 2.4, 3.3_

- [ ] 7.2 パフォーマンステストを実施する
  - 20色パレットのコントラスト再計算が200ms以内であることを確認
  - デバウンス処理が正しく機能することを確認
  - _Requirements: 4.3_

- [ ]* 7.3 E2Eテストを作成する
  - カラーピッカーで色選択後、コントラスト値が更新されることを確認
  - HEX入力後、デバウンスを経て更新されることを確認
  - ページリロード後、背景色が復元されることを確認
  - ビュー切替後、背景色が維持されることを確認
  - _Requirements: 4.1, 4.2, 5.2, 5.3_

- [ ] 7.4 統合テストを作成する
  - BackgroundColorSelector → DemoState連携の確認
  - DemoState変更 → View再レンダリングの確認
  - プリセット選択 → 背景色 + モード適用の確認
  - selector更新 → state反映 → view再計算のフロー検証
  - _Requirements: 5.1, 5.2, 5.5_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 4.1, 5.1, 5.2 |
| 1.2 | 4.1 |
| 1.3 | 4.3 |
| 1.4 | 2.2, 7.1 |
| 1.5 | 2.2, 4.1 |
| 1.6 | 4.1 |
| 2.1 | 4.2 |
| 2.2 | 4.2 |
| 2.3 | 2.1 |
| 2.4 | 2.1, 7.1 |
| 2.5 | 2.1 |
| 3.1 | 3.1 |
| 3.2 | 3.1 |
| 3.3 | 3.1, 7.1 |
| 3.4 | 3.1 |
| 3.5 | 5.2 |
| 4.1 | 4.4, 7.3 |
| 4.2 | 4.4, 7.3 |
| 4.3 | 3.1, 7.2 |
| 4.4 | 4.4 |
| 5.1 | 1.1, 5.1, 7.4 |
| 5.2 | 5.3, 7.3, 7.4 |
| 5.3 | 1.2, 7.3 |
| 5.4 | 1.2 |
| 5.5 | 5.2, 5.3, 7.4 |
| 5.6 | 5.2 |
| 6.1 | 6.1 |
| 6.2 | 6.2 |
| 6.3 | 6.3 |
| 6.4 | 6.3 |

## Parallel Execution Notes

以下のタスクは並列実行可能:
- **2.1 と 2.2**: 色変換とバリデーションは独立
- **6.1 と 6.2**: テキスト色とバッジ色の切替は独立

依存関係により順次実行が必要なタスク:
- **1.1** → 1.2: 状態フィールド追加後に永続化を実装
- **3.1** → 5.1, 5.2: コントラスト計算がビュー統合の前提
- **4.1** → 4.2, 4.3, 4.4: 基本セレクターが拡張の前提
- **5.1, 5.2, 5.3** → 6.3: UI統合後にボーダー調整
- **6.x** → 7.x: 実装完了後にテスト
