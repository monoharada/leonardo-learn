# Implementation Plan

## このタスクリストの使い方

本リストは「実装のマスタ仕様」として位置づけます：
- **GitHub Issue / チケット化時**: 各タスクを「実装」「テスト」「ドキュメント」に小分けして起票
- **日々の進捗管理**: 1タスク = 半日〜1日の作業塊として扱い、WIP制御に活用
- **レビュー・回顧**: 要件トレースを用いて「なぜこのタスクがあるか」を確認

---

## Milestone Overview

| Milestone | Goal | 主要タスク | 目安工数 |
|-----------|------|------------|----------|
| **A: MVP Core** | 最小限の動作するカラーシステム | 1.1, 1.4, 3.1, 6.4, 7.1, 10.1 | 3-4日 |
| **B: Accessibility & Collision** | DADS最適化と衝突検出 | 2.1, 2.2, 4.1, 4.3, 5.1 | 3-4日 |
| **C: Advanced Features** | CVD、M3拡張、高機能Export | 2.3, 3.2, 3.3, 4.2, 6.1-6.3 | 3-4日 |
| **D: Performance & Polish** | パフォーマンス最適化、バージョニング | 8.x, 9.x, 残りのテスト | 2-3日 |

---

## Requirements Coverage Summary

本タスクリストは以下の10要件（59 Acceptance Criteria）をカバーする：

| Requirement | Summary | Task Coverage |
|-------------|---------|---------------|
| 1 | 役割別L/C調整 | 1.1, 1.2, 1.3 |
| 2 | ニュートラルスケール | 1.4, 1.5 |
| 3 | セマンティック衝突回避 | 2.1, 2.2, 2.3 |
| 4 | M3準拠シェード | 3.1, 3.2, 3.3 |
| 5 | DADSアクセシビリティ | 4.1, 4.2, 4.3 |
| 6 | ロール自動割当 | 5.1, 5.2 |
| 7 | 出力フォーマット | 6.1, 6.2, 6.3, 6.4 |
| 8 | プレビューUI | 7.1, 7.2, 7.3 |
| 9 | パフォーマンス | 8.1, 8.2, 8.3 |
| 10 | バージョニング | 9.1, 9.2 |

---

## Tasks

- [ ] 1. ロール別パラメータ定義システム

- [x] 1.1 (P) [A] RoleConfigの型定義とデフォルト値を実装する
  - カラーロール（primary、secondary、tertiary、error、warning、success、neutral、neutralVariant）の型定義を作成する
  - 各ロールのChroma範囲、Lightness範囲、Hue範囲（オプション）を設定する構造体を定義する
  - primaryは高Chroma（0.16〜0.25）・中Lightness（40%〜70%）のデフォルト値を設定する
  - secondaryは中Chroma（0.08〜0.16）・中Lightness範囲のデフォルト値を設定する
  - tertiaryは低〜中Chroma（0.06〜0.12）のデフォルト値を設定する
  - error/warning/successの色相制約（error: 15°〜45°、warning: 60°〜90°、success: 140°〜160°）を定義する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 1.1.1 [A] RoleConfigの単体テストを作成する
  - 各ロールのデフォルト値が仕様通りか検証する
  - 無効なパラメータ範囲でエラーが発生することを確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [ ] 1.2 (P) [B] WCAGコントラスト維持機能を実装する
  - ロール別調整適用時のWCAGコントラスト比要件維持ロジックを実装する
  - コントラスト検証と自動調整のフィードバックループを構築する
  - _Requirements: 1.8_

- [ ] 1.3 [D] ロール設定カスタマイズAPIを実装する
  - ユーザーがロール別L/C/Hパラメータを上書きできるAPIを提供する
  - デフォルト設定とカスタム設定のマージロジックを実装する
  - 無効なパラメータ範囲に対するバリデーションを追加する
  - _Requirements: 1.9_

- [x] 1.4 (P) [A] ニュートラルスケール基本生成を実装する
  - 極低Chroma（0.00〜0.02）のグレースケール生成ロジックを実装する
  - 11段階以上のシェード（50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950）を生成する
  - ベースカラーの色相を維持しながら極低Chromaに変換する機能を追加する
  - 隣接シェード間のLightness差を知覚的に均一に保つアルゴリズムを適用する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 1.5 [C] ニュートラルスケールのオプションと警告を実装する
  - ピュアグレー（C=0）とウォーム/クールグレー（微小Chroma）の切り替えオプションを実装する
  - Lightness範囲（0%〜100%）超過時の自動クランプと警告表示を実装する
  - _Requirements: 2.5, 2.6_

- [ ] 2. セマンティック衝突検出システム

- [ ] 2.1 (P) [B] CollisionDetectorの基本衝突検出を実装する
  - 複数セマンティックカラー間のΔH/ΔC/ΔL計算機能を実装する
  - ベース閾値（ΔH < 30°、同一Lightness帯でΔC < 0.05かつΔL < 10%）による衝突判定を実装する
  - 衝突結果の重大度（warning/error）を判定する機能を追加する
  - _Requirements: 3.1, 3.2_

- [ ] 2.1.1 [B] CollisionDetectorの単体テストを作成する
  - 閾値境界での衝突検出パターンを網羅的にテストする
  - primary-error、warning-errorの強化閾値テストを含める
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 2.2 [B] 特定ペア強化閾値と調整提案を実装する
  - primary-error（ΔH < 45°）で強い警告と代替色相提案を生成する
  - warning-error（ΔH < 40°）でHue/Lightness調整を自動提案する
  - 調整優先順位（Chroma→Lightness→Hue）に従った提案生成ロジックを実装する
  - Hue調整を±30°以内に制限する制約を適用する
  - 閾値のカスタマイズAPIを提供する
  - _Requirements: 3.3, 3.4, 3.6, 3.7_

- [ ] 2.3-spike [C] CVDシミュレーション実装方式を検証する（Spike）
  - Brettel 1997法の自前実装 vs 既存ライブラリ（color-blindness等）を比較する
  - パフォーマンスと精度のトレードオフを検証する
  - 検証結果をdesign.mdに追記する
  - _Requirements: 3.5_

- [ ] 2.3 (P) [C] CVDシミュレーションを実装する
  - Spikeの結果に基づき最適な実装方式を選択する
  - sRGB→linearRGB→LMS→CVD変換パイプラインを構築する
  - CVDモードでの識別可能性検証機能を追加する
  - _Requirements: 3.5_

- [ ] 3. Material Design 3トーンスケール生成

- [x] 3.1 (P) [A] M3Generatorの基本トーンスケール生成を実装する
  - material-color-utilities依存を追加しHCT色空間へのアクセスを設定する
  - 13段階トーン値（0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 95, 99, 100）のスケール生成を実装する
  - HCT→ARGB→OKLCH変換パスを実装する
  - 変換精度を許容誤差ΔE < 0.01で保証する
  - _Requirements: 4.1, 4.2, 4.4_

- [x] 3.1.1 [A] M3変換精度の単体テストを作成する
  - 複数のソースカラーでΔE < 0.01を検証する
  - エッジケース（極端なChroma、gamut境界）をテストする
  - _Requirements: 4.2, 4.4_

- [ ] 3.2 (P) [C] M3 Key Colors自動生成を実装する
  - ソースカラーからKey Colors（Primary、Secondary、Tertiary、Error、Neutral、Neutral Variant）を自動生成する
  - 各Key Colorの色相/彩度調整ルールを適用する
  - _Requirements: 4.3_

- [ ] 3.3 [C] M3のライト/ダークテーマトークンとロール割当を実装する
  - ライトテーマとダークテーマ両方に対応したトークンセットを生成する
  - Surface、Container、On-Colorなどのロール割当を自動計算する
  - M3モードとDADSモードの重ねがけ時にDADSを優先する競合解決ロジックを追加する
  - _Requirements: 4.5, 4.6_

- [ ] 4. DADSスタイルアクセシビリティ最適化

- [ ] 4.1-spike [B] APCA実装方式とパフォーマンスを検証する（Spike）
  - APCA計算の既存ライブラリ（apca-w3等）と自前実装を比較する
  - WCAG 2.1 AAA と APCA Lc値の並行計算のパフォーマンスを測定する
  - 検証結果をdesign.mdに追記する
  - _Requirements: 5.1, 5.2_

- [ ] 4.1 (P) [B] DADSOptimizerの基本コントラスト最適化を実装する
  - Spikeの結果に基づき最適な実装方式を選択する
  - WCAG AAA（7:1以上）を満たすテキストカラーの自動生成機能を実装する
  - APCA（Lc値）に基づいたコントラスト計算を並行実行する
  - 基準未達時のLightness自動調整機能を実装する
  - RoleConfigレンジ超過時の警告生成を追加する
  - _Requirements: 5.1, 5.2, 5.5_

- [ ] 4.1.1 [B] DADSOptimizerの単体テストを作成する
  - AAA達成可能/不可能なケースをテストする
  - Lightness調整後のコントラスト比を検証する
  - _Requirements: 5.1, 5.2, 5.5_

- [ ] 4.2 (P) [C] 用途別コントラスト基準を適用する
  - 大文字テキスト、小文字テキスト、非テキスト要素それぞれに適切なコントラスト基準を適用する
  - 背景色との組み合わせ検証機能を実装する
  - _Requirements: 5.4_

- [ ] 4.3 [B] 推奨用途とインタラクティブ状態カラーを実装する
  - 各シェードに推奨用途（テキスト、背景、境界線、アイコン等）を自動割当する
  - フォーカスインジケーター、エラー状態、選択状態などのインタラクティブ状態用カラーを自動生成する
  - _Requirements: 5.3, 5.6_

- [ ] 5. ロール自動割当システム

- [ ] 5.1 (P) [B] RoleAssignerの基本割当ロジックを実装する
  - 各シェードに対してプライマリ用途とセカンダリ用途を自動割当する
  - 10種類のロールカテゴリ（background、surface、container、text、icon、border、focus、hover、active、disabled）を提供する
  - Lightness値に基づく用途推奨（80%以上→background/surface、20%以下→text/icon）を実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 5.1.1 [B] RoleAssignerの単体テストを作成する
  - Lightness境界値での割当が正しいか検証する
  - 全ロールカテゴリが正しく適用されるかテストする
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 5.2 [D] コントラスト検証とカスタムロール対応を実装する
  - 背景色と前景色の組み合わせでWCAGコントラスト比を検証する
  - カスタムロール定義の追加とデフォルトロールの上書きを許可するAPIを提供する
  - _Requirements: 6.5, 6.6_

- [ ] 6. エクスポートフォーマット対応

- [ ] 6.1 (P) [C] CSSエクスポーターを実装する
  - CSS Custom Properties形式でのエクスポート（OKLCH値 + sRGB fallback）を実装する
  - @supportsによる広色域検出付きfallback形式を生成する
  - セマンティックトークン名（--color-primary-500等）の自動生成を実装する
  - _Requirements: 7.1, 7.5, 7.6, 7.7_

- [ ] 6.2 (P) [C] DTCGエクスポーターを実装する
  - W3C Design Tokens（DTCG）形式でのエクスポートを実装する
  - semanticトークンとaliasトークンの分離を行う
  - $value、$type形式に準拠した出力を生成する
  - _Requirements: 7.2_

- [ ] 6.3 (P) [C] Tailwindエクスポーターを実装する
  - Tailwind CSS設定形式（theme.extend.colors）でのエクスポートを実装する
  - OKLCH値を使用したカラー定義を生成する
  - _Requirements: 7.3_

- [x] 6.4 (P) [A] JSONエクスポーターを実装する
  - JSON形式でのraw dataエクスポートを実装する
  - OKLCH、sRGB、Display P3形式での色値提供を実装する
  - _Requirements: 7.4, 7.5_

- [x] 6.4.1 [A] Exportersのスナップショットテストを作成する
  - 特定の入力に対する各フォーマットの出力をゴールデンとして保存する
  - リグレッション検出用のテストケースを用意する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 7. ColorSystemファサードとプレビュー機能

- [x] 7.1 (P) [A] ColorSystemファサードクラスを実装する
  - generate()、export()、save()、load()、compareParams()の統合APIを実装する
  - 4つのモード（default、m3、dads、m3+dads）の切り替えを実装する
  - 各コンポーネント（RoleConfig、M3Generator、DADSOptimizer、CollisionDetector、RoleAssigner、Exporters）を統括する
  - 衝突検出と提案の自動/手動適用オプションを実装する
  - 生成結果のwarnings（レンジ超過、コントラスト不可等）を集約する
  - _Requirements: 8.1_

- [ ] 7.2 [C] スケールプレビューとアクセシビリティ表示を実装する
  - スケール全体の視覚的プレビュー機能を実装する
  - 各シェードのWCAG AA/AAA準拠状態をインジケーター表示する
  - 特定シェード選択時の詳細情報（OKLCH値、コントラスト比、推奨用途）表示を実装する
  - _Requirements: 8.2, 8.3, 8.4_

- [ ] 7.3 [C] テーマ切替と修正提案表示を実装する
  - ライトモード/ダークモードのプレビュー切り替えを実装する
  - アクセシビリティ違反箇所のハイライトと修正提案表示を実装する
  - _Requirements: 8.5, 8.6_

- [ ] 8. パフォーマンス最適化

- [ ] 8.1 [D] キャッシュシステムを実装する
  - 同一パラメータでの再生成を即座に返すキャッシュ機能を実装する
  - キャッシュキー設計（`${sourceHex}-${mode}-${rolesHash}`）を実装する
  - 最大100件のキャッシュエントリ管理（LRU削除）を実装する
  - _Requirements: 9.4_

- [ ] 8.2 [D] パフォーマンス目標達成を検証する
  - 単一スケール（13シェード）50ms以内の生成を達成する
  - 完全テーマ（6ロール × 13シェード）300ms以内の生成を達成する
  - 複数スケール生成時の並列処理最適化を実装する
  - _Requirements: 9.1, 9.2, 9.3_

- [ ] 8.3 [D] 増分更新と非同期処理を実装する
  - 部分的なパラメータ変更時の差分再計算（増分更新）を実装する
  - UIスレッドをブロックしない非同期生成（requestIdleCallback等）を実装する
  - _Requirements: 9.5, 9.6_

- [ ] 9. バージョニングと再現性

- [ ] 9.1 [D] ParameterStoreの保存/復元を実装する
  - 生成に使用したすべての入力パラメータをJSONとして保存する機能を実装する
  - 保存されたパラメータセットから完全に同一のカラーパレットを再生成する（決定論的生成）
  - パラメータセットにバージョン番号、タイムスタンプ、エンジンバージョンを付与する
  - checksumによるパラメータセットの一意識別を実装する
  - _Requirements: 10.1, 10.2, 10.3, 10.6_

- [ ] 9.2 (P) [D] パラメータ比較とインポート/エクスポートを実装する
  - 2つのパラメータセット間の差分を一覧表示する機能を実装する
  - パラメータセットのインポート/エクスポート機能を提供する
  - _Requirements: 10.4, 10.5_

- [ ] 10. 統合とテスト

- [x] 10.1 [A] demo.tsへのColorSystem統合を実装する
  - 既存のdemo.tsにColorSystemファサードを統合する
  - モード切り替えUI、プレビュー表示、エクスポート機能を接続する
  - 既存のgenerateSystemPalette()との後方互換性を維持する（defaultモードでラップ）
  - 100ms以内のプレビュー更新を達成する
  - _Requirements: 8.1_

- [ ] 10.2 [D] 統合テストとパフォーマンス検証を実施する
  - 全モード（default、m3、dads、m3+dads）での生成フローをテストする
  - キャッシュヒット/ミスの動作を検証する
  - パラメータ保存/復元の往復テストを実施する
  - HCT→OKLCH変換精度（ΔE < 0.01）を検証する
  - パフォーマンス目標（単一50ms、完全300ms、キャッシュ5ms）を検証する
  - _Requirements: 4.2, 9.1, 9.2_
