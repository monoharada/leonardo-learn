# Implementation Plan

## Task Overview
CUD-aware Harmony Generator機能の実装タスク。ブランドカラーを核にCUD推奨配色に寄せつつ、ブランド調とも破綻しないハーモニー生成を実現する。

---

## Tasks

- [x] 1. CUD許容ゾーン判定機能の実装
- [x] 1.1 (P) ゾーン分類ロジックの実装
  - deltaE値からSafe/Warning/Offゾーンを判定する機能を作成
  - デフォルト閾値（Safe: 0.05、Warning: 0.12）を定数として定義
  - ゾーン判定結果にdeltaE値と閾値情報を含めて返却
  - カスタム閾値を検証する機能（Safe < Warningの順序チェック）を実装
  - _Requirements: 2.1, 2.3, 2.4, 2.5, 2.6_

- [x] 1.2 (P) ゾーン機能のユニットテスト
  - 境界値テスト（deltaE = 0.05, 0.12の境界ケース）
  - カスタム閾値の適用テスト
  - 不正な閾値設定の検証テスト
  - _Requirements: 2.2, 8.4_

- [x] 2. アンカーカラー管理機能の実装
- [x] 2.1 アンカーカラー状態管理の実装
  - ブランドカラー入力から最も近いCUD推奨色を検索する機能
  - MatchLevel（exact/near/moderate/off）に基づく自動優先度判定
  - 優先度設定（brand/cud）に応じた実効色の決定ロジック
  - アンカーカラー状態のイミュータブル管理
  - 既存`findNearestCudColor()`との統合
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 2.2 (P) アンカーカラー機能のユニットテスト
  - exact/near/moderate/off各MatchLevelでの優先度判定テスト
  - 優先度変更による実効色切り替えテスト
  - CUD推奨色との距離計算の精度検証
  - _Requirements: 8.4_

- [x] 3. ブランド調和スコア計算機能の実装
- [x] 3.1 (P) 調和スコア計算ロジックの実装
  - 色相距離スコア（OKLCHの色相角度に基づく円周距離計算）
  - 明度差スコア（パレット内の明度分布評価）
  - コントラスト適合度スコア（アンカーとの可読性評価）
  - 加重平均による総合スコア算出（0-100スケール）
  - デフォルト重み（hue: 0.4, lightness: 0.3, contrast: 0.3）の定義
  - _Requirements: 4.1, 4.2, 4.5_

- [x] 3.2 (P) 調和スコア警告判定と代替提案の実装
  - 閾値（デフォルト: 70）以下で警告を表示する判定機能
  - 調和スコア優先の代替パレット提案機能
  - _Requirements: 4.3, 4.4_

- [x] 3.3 (P) 調和スコア機能のユニットテスト
  - 重み変更による総合スコアへの影響テスト
  - 内訳スコアの個別検証
  - 警告閾値判定テスト
  - _Requirements: 8.4_

- [x] 4. Soft Snap機能の実装
- [x] 4.1 Soft Snapロジックの実装
  - Safe Zone（スナップなし）、Warning Zone（戻り係数付き部分スナップ）、Off Zone（Warning境界までスナップ）の3パターン処理
  - OKLab空間での線形補間によるソフトスナップ
  - ガマットクランプ（sRGB範囲外の補正）
  - 戻り係数（0.0-1.0）によるスナップ量調整
  - Zoneモジュールとの統合（ゾーン判定結果の利用）
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 4.2 (P) Soft Snap説明文自動生成の実装
  - 「この色はブランド維持のためCUDからΔE=X.XXで許容」形式の説明文生成
  - 補正前後のdeltaE変化量を計算して返却
  - _Requirements: 5.4, 5.6_

- [x] 4.3 (P) Soft Snap機能のユニットテスト
  - 各ゾーンでのスナップ動作検証
  - 戻り係数の効果テスト（0.0, 0.5, 1.0）
  - ガマットクランプの動作確認
  - _Requirements: 8.4_

- [x] 5. CUD最適化アルゴリズムの実装
- [x] 5.1 目的関数と最適化ロジックの実装
  - 候補色に対するCUD距離（deltaE）の計算
  - 目的関数（Σ CUD距離 + λ × (1 - 調和スコア/100)）の実装
  - 貪欲法による最適化アルゴリズム
  - モード別処理（SoftはSafe/Warning優先選択、Strictは完全スナップ）
  - Anchor、Zone、HarmonyScore、Snapperモジュールとの統合
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5.2 最適化結果と警告の実装
  - 目的関数値とCUD準拠率を結果に含める
  - Off Zone色が残る場合の警告と代替候補提案
  - 処理時間の計測と結果への付加
  - _Requirements: 3.5, 3.6_

- [x] 5.3 最適化機能のユニットテスト
  - Soft/Strictモードでの最適化動作検証
  - λパラメータの効果テスト
  - CUD準拠率の算出精度テスト
  - _Requirements: 8.4_

- [x] 6. 4段階モードセレクターUIの実装
- [x] 6.1 モードセレクターUIコンポーネントの実装
  - Off/Guide/Soft Snap/Strictの4モード選択UI
  - モード名とアイコン（○/◐/◉/●）による視覚的識別
  - 日本語ラベルと説明文の表示
  - 既存`createCudModeSelector`の4モード対応拡張
  - _Requirements: 6.1, 6.3_

- [x] 6.2 モード切替とプレビュー更新の実装
  - モード変更時のパレット即時再計算
  - Optimizerモジュールとの連携による最適化実行
  - _Requirements: 6.2_

- [x] 6.3 モード別バッジ表示の実装
  - Guideモード: ゾーン（Safe/Warning/Off）バッジ表示
  - Soft Snapモード: ΔE変化量バッジ表示
  - Strictモード: 緑色チェックマーク表示
  - _Requirements: 6.4, 6.5, 6.6_

- [x] 6.4 (P) モード設定のLocalStorage永続化
  - モード選択のLocalStorage保存・復元
  - 旧3モード値との後方互換性対応
  - _Requirements: 6.7_

- [x] 7. エクスポート機能の拡張
- [x] 7.1 (P) JSONエクスポートのCUDメタデータ追加
  - 各色のCUD推奨色ID/名称、deltaE値、ゾーン判定を含める
  - パレット全体のCUD準拠率とモード情報を含める
  - Strict時の完全準拠フラグを含める
  - _Requirements: 7.1, 7.2, 7.4_

- [x] 7.2 (P) CSSエクスポートのCUDコメント追加
  - CSSカスタムプロパティにCUD情報をコメントとして付加
  - 例: `--color-primary: #FF2800; /* CUD: 赤 (exact, ΔE=0.000) */`
  - _Requirements: 7.3_

- [x] 7.3 (P) エクスポート時のCUD検証サマリー表示
  - エクスポート前に警告数・エラー数のサマリーを表示
  - _Requirements: 7.5_

- [x] 8. 非機能要件の実装と検証
- [x] 8.1 パフォーマンス最適化
  - 20色パレットで200ms以内の最適化完了
  - 不要な再計算の回避（モード未変更時のキャッシュ）
  - CUD色データのモジュール初期化時キャッシュ
  - _Requirements: 8.1_

- [x] 8.2 長時間処理のUXフィードバック
  - 最適化処理中のプログレス表示
  - 500ms超過時の「計算中...」メッセージ表示
  - キャンセルボタンの有効化
  - _Requirements: 8.2, 8.6_

- [x] 8.3 (P) 型安全性とコード品質の確認
  - TypeScript strict modeの適用確認
  - 新規APIの90%以上テストカバレッジ達成
  - _Requirements: 8.3, 8.4_

- [x] 8.4 (P) 設計判断のADR文書化
  - CUD最適化アルゴリズムの設計判断をADRとして記録
  - _Requirements: 8.5_

- [x] 9. 統合テストとE2Eテスト
- [x] 9.1 統合テストの実装
  - 最適化フロー全体（Anchor → Optimizer → Snapper → Result）の検証
  - UIフロー（ModeSelector → Optimizer → Preview更新）の検証
  - エクスポートフロー（Optimizer → JSONExporter → CUDメタデータ）の検証
  - _Requirements: 8.4_

- [x] 9.2 E2Eテストの実装
  - 4モード全ての切替とプレビュー更新の検証
  - ブランドカラー入力から最適化、エクスポートまでの一連フロー検証
  - _Requirements: 8.4_

- [x] 9.3 パフォーマンステストの実装
  - 20色パレット最適化の200ms以内完了確認
  - 100回連続最適化でのメモリリーク確認
  - モード切替の100ms以内レスポンス確認
  - _Requirements: 8.1_

---

## Requirements Coverage Matrix

| Requirement | Task(s) |
|-------------|---------|
| 1.1, 1.2, 1.3, 1.4, 1.5, 1.6 | 2.1 |
| 2.1, 2.2, 2.3, 2.4, 2.5, 2.6 | 1.1, 1.2 |
| 3.1, 3.2, 3.3, 3.4, 3.5, 3.6 | 5.1, 5.2 |
| 4.1, 4.2, 4.3, 4.4, 4.5, 4.6 | 3.1, 3.2, 4.1 |
| 5.1, 5.2, 5.3, 5.4, 5.5, 5.6 | 4.1, 4.2 |
| 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7 | 6.1, 6.2, 6.3, 6.4 |
| 7.1, 7.2, 7.3, 7.4, 7.5 | 7.1, 7.2, 7.3 |
| 8.1, 8.2, 8.3, 8.4, 8.5, 8.6 | 8.1, 8.2, 8.3, 8.4, 9.1, 9.2, 9.3 |
