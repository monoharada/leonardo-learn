# Implementation Plan

## 要件カバレッジ

| 要件ID | 概要 | タスク |
|--------|------|--------|
| 1.1 | 全130色スコア計算・ソート | 1.1, 1.2 |
| 1.2 | バランススコア（0-100）計算 | 1.1 |
| 1.3 | 上位10件の推奨リスト | 1.2 |
| 1.4 | ブランドカラー未設定時の処理 | 2.1 |
| 1.5 | 背景色未設定時のデフォルト処理 | 2.1 |
| 2.1 | 3指標のスコア計算 | 1.1 |
| 2.2 | デフォルト重み付け適用 | 1.1 |
| 2.3 | 重み正規化（合計100保証） | 1.1 |
| 2.4 | 背景色変更時の再計算 | 1.3 |
| 2.5 | スコア内訳表示 | 4.2 |
| 3.1 | ハーモニータイプフィルタ | 3.1 |
| 3.2 | ±30°以内の候補抽出 | 3.1 |
| 3.3 | フィルタ後のソート維持 | 3.2 |
| 3.4 | 候補0件時の代替表示 | 3.2 |
| 4.1 | アクセント選定パネル表示 | 4.1 |
| 4.2 | 候補カードグリッド表示 | 4.2 |
| 4.3 | 候補選択・パレット追加 | 4.3 |
| 4.4 | 選択後の調整（削除・変更） | 4.3 |
| 5.1 | カスタムアクセント追加機能 | 5.1 |
| 5.2 | DADSシェード一覧からの選択 | 5.1 |
| 5.3 | 手動追加色のスコア表示 | 5.1 |
| 5.4 | 低スコア警告表示 | 5.2 |
| 6.1 | 200ms以内のパフォーマンス | 6.1 |
| 6.2 | スコアメモ化 | 1.3 |
| 6.3 | フィルタ時の再計算回避 | 3.2 |
| 7.1 | DADSデータ読み込みエラー処理 | 2.1, 4.1 |
| 7.2 | スコア計算エラー処理 | 2.2, 2.3 |
| 7.3 | エラー時キャッシュ不使用 | 2.2 |

---

## タスク一覧

- [x] 1. バランススコア計算サービスの実装

- [x] 1.1 BalanceScoreCalculator コア機能の実装
  - ハーモニースコア計算を実装（既存の `calculateHueDistanceScore()` を活用、0-100スケールで返却）
  - CUDスコア計算を実装: `findNearestCudColor()` からΔEを取得し、`score = clamp(0, 100, 100 - (deltaE / 0.20) * 100)` で正規化（ΔE=0で100点、ΔE≥0.20で0点）
  - コントラストスコア計算を実装: `getContrast()` でコントラスト比を取得し、`score = clamp(0, 100, ((contrastRatio - 1) / 6) * 100)` で正規化（比1.0で0点、比7.0以上で100点）
  - 3指標の加重平均によるバランススコア計算を実装（デフォルト重み: ハーモニー40%、CUD30%、コントラスト30%）
  - 重み正規化機能を実装（合計100保証、端数調整ロジック含む）
  - HEX入力の正規化機能を実装（大文字統一、3桁展開、#プレフィックス保証）
  - 背景色フォールバック機能を実装（無効値または未設定時は#FFFFFFを使用）
  - **依存**: なし（他タスクから参照される基盤）
  - _Requirements: 1.2, 2.1, 2.2, 2.3_

- [x] 1.2 AccentCandidateService 候補生成機能の実装
  - DADSトークンからchromatic候補（10色相×13ステップ = 130色）を抽出
  - 全候補に対するスコア一括計算を実装
  - スコア降順ソート（同スコア時は主要ステップ500/600/700/800を優先）を実装
  - 上位N件（デフォルト10件）の推奨リスト取得機能を実装
  - **依存**: 1.1（BalanceScoreCalculatorのAPI確定後）
  - _Requirements: 1.1, 1.3_

- [x] 1.3 スコアキャッシュ機構の実装
  - 二段階キャッシュ構造を実装:
    - **partialScoreCache**: キー=`${normalizedBrandHex}_${normalizedCandidateHex}`（ブランド色+候補色）、値=ハーモニー・CUDスコア（背景色・重み非依存）
    - **fullScoreCache**: キー=`${normalizedBrandHex}_${normalizedCandidateHex}_${normalizedBackgroundHex}_${normalizedHarmony}_${normalizedCud}_${normalizedContrast}`（ブランド色+候補色+背景色+正規化済み重み3値）、値=完全スコア結果
  - キャッシュキーには正規化済みHEX・正規化済み重みを使用（入力バリエーションによるキャッシュミスを防止）
  - 背景色変更時の部分再計算機能を実装（コントラストスコアのみ再計算、partialScoreCacheを活用）
  - 重み変更時のキャッシュ無効化ポリシーを実装（fullScoreCacheをクリアして再計算）
  - **依存**: 1.1, 1.2（スコア計算・候補生成のAPI確定後）
  - _Requirements: 2.4, 6.2_

- [x] 2. エラーハンドリングの実装

- [x] 2.1 (P) 入力バリデーションとエラー処理
  - ブランドカラー未設定時のエラーハンドリングを実装（エラーコード: BRAND_COLOR_NOT_SET）
  - 無効なHEX形式の検出と InvalidColorError 送出を実装
  - DADSデータ読み込み失敗時のエラーハンドリングを実装（エラーコード: DADS_LOAD_FAILED、エラーメッセージ: 「DADSデータの読み込みに失敗しました」）
  - 背景色未設定/無効時のフォールバック処理を実装（#FFFFFF使用）
  - _Requirements: 1.4, 1.5, 7.1_

- [x] 2.2 (P) スコア計算エラー処理とキャッシュポリシー
  - スコア計算中のエラーハンドリングを実装（エラーコード: SCORE_CALCULATION_FAILED）
  - エラー発生時の全キャッシュクリア機能を実装（partialScoreCache + fullScoreCache）
  - 不完全な計算結果のキャッシュ禁止ポリシーを実装
  - DADSエラー状態のリセット機能を実装
  - _Requirements: 7.2, 7.3_

- [x] 2.3 エラー時のUI状態管理
  - スコア計算エラー時に自動選定を無効化しつつ、手動選択は継続可能とするエラー状態を実装
  - エラー状態フラグ（autoSelectionDisabled: boolean）の管理を実装
  - 手動選択パネルへのエラー状態伝播（スコア表示なしで色選択のみ許可）を実装
  - SCORE_CALCULATION_FAILED時のユーザー向けエラーメッセージ表示を実装（「スコア計算中にエラーが発生しました」）
  - **依存**: 2.2（エラーコード定義後）
  - _Requirements: 7.2_

- [x] 3. ハーモニーフィルタの実装

- [x] 3.1 (P) HarmonyFilterCalculator の実装
  - ハーモニータイプ定義を実装（all, complementary, triadic, analogous, split-complementary）
  - 各ハーモニータイプのターゲット色相計算を実装
  - ±30°の循環距離判定機能を実装（色相0-360°の循環対応）
  - 候補が指定色相範囲内かどうかの判定機能を実装
  - **Creates:** `src/core/accent/harmony-filter-calculator.ts`, `src/core/accent/harmony-filter-calculator.test.ts`
  - _Requirements: 3.1, 3.2_

- [x] 3.2 フィルタ適用とソート維持の実装
  - ハーモニーフィルタの適用機能を実装（スコア再計算なし）
  - フィルタ後のスコア順ソート維持を実装
  - フィルタ結果0件時の代替候補算出機能を実装（最も近い色相の候補を最大3件）
  - "all"フィルタ選択時の早期リターン最適化を実装
  - **依存**: 3.1（HarmonyFilterCalculatorのAPI確定後）
  - **Creates:** `src/core/accent/harmony-filter-service.ts`, `src/core/accent/harmony-filter-service.test.ts`
  - _Requirements: 3.3, 3.4, 6.3_

- [ ] 4. アクセント選定パネルUIの実装

- [ ] 4.1 AccentSelectorPanel 基本UIの実装
  - パネルの開閉制御を実装
  - ブランドカラー未設定時の無効化表示とエラーメッセージを実装
  - DADSデータ読み込み失敗時のエラーメッセージ表示（「DADSデータの読み込みに失敗しました」）とアクセント選定機能無効化を実装
  - ローディング状態の表示を実装
  - エラー状態の表示を実装
  - **依存**: 2.1, 2.3（エラー状態管理の確定後）
  - _Requirements: 4.1, 7.1_

- [ ] 4.2 (P) AccentCandidateGrid 候補表示UIの実装
  - 候補カードのグリッド表示を実装
  - 各カードにカラースウォッチ、DADSソース名、総合スコアを表示
  - ホバー時のスコア内訳（ハーモニー/CUD/コントラスト）表示を実装
  - _Requirements: 4.2, 2.5_

- [ ] 4.3 候補選択とパレット連携の実装
  - 候補カードクリック時のアクセント選択機能を実装
  - 選択したアクセントのパレットへの追加を実装（Demo State連携）
  - 選択済みアクセントの削除機能を実装
  - 選択済みアクセントの別候補への変更機能を実装
  - **依存**: 4.1, 4.2（UI基盤確定後）
  - _Requirements: 4.3, 4.4_

- [ ] 4.4 (P) HarmonyFilter UI と WeightSlider UI の実装
  - ハーモニータイプ選択ドロップダウンを実装
  - フィルタ変更時の候補リスト更新を実装
  - 重み調整スライダー（3つ: ハーモニー/CUD/コントラスト）を実装
  - 重み変更時のスコア再計算トリガーを実装
  - _Requirements: 3.1, 2.3_

- [ ] 5. 手動選択機能の実装

- [ ] 5.1 ManualAccentSelector の実装
  - 手動選択パネルの開閉制御を実装
  - カテゴリタブ表示を実装（Chromatic/Neutral/Semantic の3種）
  - Chromaticカテゴリでの色相タブ表示を実装
  - Neutral/Semanticカテゴリでのトークン一覧表示を実装
  - トークン選択時のプレビューとスコア自動計算を実装（エラー時はスコア非表示で色選択のみ許可）
  - 選択したトークンの追加機能を実装
  - **依存**: 2.3（エラー時の手動選択継続ポリシー確定後）
  - _Requirements: 5.1, 5.2, 5.3, 7.2_

- [ ] 5.2 低スコア警告の実装
  - 総合スコア50未満の判定機能を実装
  - 低スコア警告トースト表示を実装（追加は許可）
  - _Requirements: 5.4_

- [ ] 6. パフォーマンス最適化とテスト

- [ ] 6.1 パフォーマンス検証と最適化
  - 130色スコア計算のパフォーマンステストを実装（200ms以内を検証）
  - キャッシュヒット時のパフォーマンステストを実装（10ms以内を検証）
  - フィルタ適用のパフォーマンステストを実装（5ms以内を検証）
  - 必要に応じた最適化の実施
  - _Requirements: 6.1_

- [ ] 6.2 (P) ユニットテストの実装
  - BalanceScoreCalculator のテストを実装（既知の色ペアで期待スコア検証、CUD/コントラストの正規化式検証含む）
  - 重み正規化のテストを実装（合計100保証、端数処理、境界値）
  - HarmonyFilterCalculator のテストを実装（各ハーモニータイプの色相計算）
  - 循環距離判定のテストを実装（±30°判定）
  - エラーハンドリングのテストを実装
  - _Requirements: 1.2, 2.1, 2.3, 3.1, 3.2_

- [ ] 6.3 (P) 統合テストの実装
  - AccentCandidateService の統合テストを実装（DADSデータ読み込み→スコア計算→ソート）
  - メモ化動作のテストを実装（同一条件での2回目呼び出しがキャッシュヒット）
  - 背景色変更時の再計算テストを実装
  - 重み変更時のキャッシュ無効化テストを実装
  - エラー時のキャッシュクリア動作テストを実装
  - _Requirements: 6.2, 2.4, 7.3_

- [ ] 6.4 E2Eテストの実装
  - アクセント選定パネルの表示/非表示テストを実装
  - 候補カードクリック→パレット追加のテストを実装
  - ハーモニーフィルタ切替→候補リスト更新のテストを実装
  - 重みスライダー変更→スコア再計算のテストを実装
  - 手動選択フローのテストを実装
  - エラー時の手動選択継続テストを実装
  - _Requirements: 4.1, 4.3, 3.1, 2.3, 5.1, 7.2_
